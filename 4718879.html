<!DOCTYPE html>
<html>
    <head>
        <title>Мегафон - Телеком API : Примеры кода.py</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Мегафон - Телеком API</a></span>
                            </li>
                                                    <li>
                                <span><a href="3309691.html">Мегафон.API : описание программных интерфейсов</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Мегафон - Телеком API : Примеры кода.py
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Sergei Naumov</span>, last modified on Dec 03, 2018
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <div class="contentLayout2">
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p><br/></p><h2 id="id-Примерыкода.py-Аутентификация">Аутентификация</h2></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p>После получения токена на портале разработчика, он может быть использован при создании соединения следующим образом</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: py; gutter: false; theme: Midnight" data-theme="Midnight">endpoint_url = &#39;ws://192.168.1.56/v0/api&#39;
jwt_token = &#39;eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpbnN0YW5....................&#39;

async def megafonTestCall():
    megafon = Server(endpoint_url,headers={&#39;Authorization&#39;:&#39;JWT &#39;+jwt_token})</pre>
</div></div><p class="auto-cursor-target">При работе из JavaScript <u><strong><span style="color: rgb(0,51,102);">изнутри</span></strong></u> браузера, добавить заголовок не удается. В этом случае можно использовать Basic-авторизацию (см. примеры на JavaScript в <a href="https://github.com/megafonapi/examples/tree/master/javascript" style="letter-spacing: 0.0px;" class="external-link" rel="nofollow">репозитарии примеров на github'е</a>)</p></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="id-Примерыкода.py-Загрузкаголосовыхфайловнасервер/выгрузкассервера">Загрузка голосовых файлов на сервер / выгрузка с сервера</h2></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p class="auto-cursor-target">Каждая учетная запись получает на сервере API пространство для загрузки голосовых приветствий. Формат файлов  - одноканальный файл A-law  с битрейтом 8KHz. Сделать это можно любым средством (sox, audacity, mencoder и т.п.). Пример соответствующих ключей для sox'а в Linux'е приведен ниже. Доступ к  файлам осуществляется через WebDAV.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Midnight" data-theme="Midnight">$ sox -V Sound_16839.mp3 -r 8000 -c 1 -t al hello.alaw
$ curl -X GET --basic --user 7928135xxxx:7928135xxxx http://83.149.26.165/api/media/</pre>
</div></div></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="id-Примерыкода.py-Инициироватьвызовнаабонента">Инициировать вызов на абонента</h2></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p>Приведенный ниже пример осуществляет исходящий вызов, играет заданное приветствие и вешает трубку. Необходимо обратить внимание на наличие асинхронных вызовов и необходимость кодирования звуковых фрагментов (см. выше). Также необходимо помнить, что</p><ul><li>метод <code><a href="3309756.html">MakeCall</a> </code><strong>НЕ УСТАНАВЛИВАЕТ</strong> оба плеча  вызова между <code>anum</code> и <code>bnum</code>, а организует вызов &quot;из облака&quot; на <code>bnum</code> и при этом на экране телефона при входящем вызове показан номер <code>anum</code>. </li><li>номер <code>anum</code> <strong>НЕ МОЖЕТ</strong> быть произвольным, он, во избежание фальсификаций, может быть только из списка привязанных к учетной записи, под которой работает разработчик.</li></ul><p>Для организации полноценного вызова между абонентами <code>bnum<sub>1 </sub>и </code>bnum<sub>2 </sub>необходимо совершить два вызова <code>MakeCall: </code>на номер<code> bnum<sub>1</sub>, на номер </code>bnum<sub>2</sub> и объединить их вместе (см. метод <a href="4718672.html"><code>TromboneCall</code></a> и пример ниже). </p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: py; gutter: true; theme: Midnight" data-theme="Midnight">import json
import asyncio

from jsonrpc_websocket import Server

async def megafonTestCall():
    megafon = Server(&#39;ws://83.149.26.165/api/v0/example/socket&#39;,headers={&#39;Authorization&#39;:&#39;JWT eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpbnN0YW5jZV9pZCIgOiAiZTA0NzZkNmUtY&#39;})
    ret = &#39;&#39;
    try:
        await megafon.ws_connect()
        ret = await megafon.MakeCall(anum=&#39;79280000000&#39;,bnum=&#39;79282120069&#39;,record=False)
        if ret and ret[&#39;data&#39;] and ret[&#39;data&#39;][&#39;call_session&#39;]:
            await megafon.PlayAnouncement(call_session=ret[&#39;data&#39;][&#39;call_session&#39;],filename=&#39;hello.alaw&#39;)
            await megafon.TerminateCall(call_session=ret[&#39;data&#39;][&#39;call_session&#39;])

    finally:
        await megafon.close()
        await megafon.session.close()
asyncio.get_event_loop().run_until_complete(megafonTestCall())</pre>
</div></div></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="id-Примерыкода.py-Создатьконференциюизнесколькихучастников">Создать конференцию из нескольких участников</h2></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p class="auto-cursor-target">Приведенный ниже пример реализует сценарий объединения нескольких участников в одну голосовую конференцию, с приветствием каждого по вхождению, запись конференции в звуковой файл для выгрузки.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: py; gutter: false; theme: Midnight" data-theme="Midnight">import json
import asyncio
from jsonrpc_websocket import Server

async def megafonTestConf():
    phones = [&#39;7928212....&#39;,&#39;7928124....&#39;,&#39;7928213....&#39;,&#39;7928777....&#39;]
    conf,sub = &#39;&#39;,&#39;&#39;
    megafon = Server(&#39;ws://192.168.1.165/v0/api&#39;,headers={&#39;Authorization&#39;:&#39;JWT eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpbnN0YW5jZV9&#39;})
    try:
        await megafon.ws_connect()
        conf = await megafon.CreateConf(number=&#39;5&#39;,record=True)
        if conf and conf[&#39;data&#39;] and conf[&#39;data&#39;][&#39;conf_session&#39;]:
            print(&#39;Конференция создана&#39;)
            for i in range(len(phones)):
                sub = await megafon.MakeCall(anum=&#39;7928135....&#39;,bnum=phones[i],record=False)
                if sub and sub[&#39;data&#39;] and sub[&#39;data&#39;][&#39;call_session&#39;]:
                    await megafon.AddToConf(conf_session=conf[&#39;data&#39;][&#39;conf_session&#39;],
                                            call_session=sub[&#39;data&#39;][&#39;call_session&#39;],
                                            mute=False,deaf_mute=False)
                    print(f&#39;Участник {phones[i]} в конференции&#39;)
                    await megafon.PlayAnouncement(call_session=sub[&#39;data&#39;][&#39;call_session&#39;],filename=&#39;hello.alaw&#39;)                    
    finally:
# напечатаем для информации
        print(json.dumps(conf))
        await megafon.close()
        await megafon.session.close()
asyncio.get_event_loop().run_until_complete(megafonTestConf())</pre>
</div></div></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="id-Примерыкода.py-ПолучитьDTMF-кодынажатиянацифровойклавиатуретелефона">Получить DTMF-коды нажатия на цифровой клавиатуре телефона</h2></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p class="auto-cursor-target">В приведенном ниже примере показано получение кодов нажатий пользователя на цифровой клавиатуре.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: py; gutter: false; theme: Midnight" data-theme="Midnight"></pre>
</div></div></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="id-Примерыкода.py-Обработкавходящеговызоваиегоперенаправлениенадругойномер">Обработка входящего вызова и его перенаправление на другой номер</h2></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p class="auto-cursor-target">Пример показывает обработку входящего звонка, обработку события, проигрывание сообщения пользователю и перенаправление на другой номер</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: py; gutter: false; theme: Midnight" data-theme="Midnight"></pre>
</div></div></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h2 id="id-Примерыкода.py-Организоватьсоединениедвухидущихсессий(тромбонинг)">Организовать соединение двух идущих сессий (тромбонинг)</h2></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<p class="auto-cursor-target">Пример позволяет показать как можно соединить две идущие голосовые сессии. Одна из них - исходящий вызов, другая - входящий.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: py; gutter: false; theme: Midnight" data-theme="Midnight">import json
import asyncio
from jsonrpc_websocket import Server

async def megafonTestCall():
    megafon = Server(&#39;ws://192.168.1.165/v0/api&#39;,headers={&#39;Authorization&#39;:&#39;JWT eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpbnN0YW5jZV9pZCIg&#39;})
    sub1,sub2,record = &#39;&#39;,&#39;&#39;,&#39;&#39;
    try:
        await megafon.ws_connect()
        sub1 = await megafon.MakeCall(anum=&#39;7928135.....&#39;,bnum=&#39;7928212....&#39;,record=True)
        if sub1 and sub1[&#39;data&#39;] and sub1[&#39;data&#39;][&#39;call_session&#39;]:
            print(&#39;call to 7928212....&#39;)
        sub2 = await megafon.MakeCall(anum=&#39;7928135....&#39;,bnum=&#39;7928777....&#39;,record=True)
        if sub2 and sub2[&#39;data&#39;] and sub2[&#39;data&#39;][&#39;call_session&#39;]:
            print(&#39;call to 7928777....&#39;)
        record = await megafon.TromboneCall(a_session=sub1[&#39;data&#39;][&#39;call_session&#39;],
                                            b_session=sub2[&#39;data&#39;][&#39;call_session&#39;])
    finally:
# напечатаем для информации
        print(json.dumps(sub1))
        print(json.dumps(sub2))
        print(json.dumps(record))
        await megafon.close()
        await megafon.session.close()
asyncio.get_event_loop().run_until_complete(megafonTestCall())</pre>
</div></div></div>
</div>
</div>
</div>
                    </div>

                    
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Dec 04, 2018 15:51</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
