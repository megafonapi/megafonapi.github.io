<!DOCTYPE html>
<html>
    <head>
        <title>Мегафон - Телеком API : Примеры кода.js</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Мегафон - Телеком API</a></span>
                            </li>
                                                    <li>
                                <span><a href="3309691.html">Мегафон.API : описание программных интерфейсов</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Мегафон - Телеком API : Примеры кода.js
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Alexey Brykov</span>, last modified on Nov 21, 2018
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <div class="contentLayout2">
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="id-Примерыкода.js-Cозданиеисходящеговызова,созданиеконференцииидобавлениевызовавконференцию">Cоздание исходящего вызова, создание конференции и добавление вызова в конференцию</h1></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">var JsonRpcWs = require(&#39;json-rpc-ws&#39;);
var client = JsonRpcWs.createClient();

/*
 * Пример, демонстрирует создание исходящего вызова, создание конференции и добавление вызова в конференцию.
 */

client.connect(&#39;ws://10.0.0.233:8080/cc&#39;, function connected () {
    var makecall = { anum: &#39;500&#39;, bnum: &#39;3000&#39; }
    var termcall = { session: &#39;&#39; }
    var createconf = { number: &#39;3000&#39;, record: true }
    var delconf = { conf_session: &#39;&#39; }
    var addtoconf = { conf_session: &#39;&#39;, session: &#39;&#39;, mute: &#39;&#39;, deaf_mute: &#39;&#39; }
    
    client.send(&#39;MakeCall&#39;, makecall, function mirrorReply (error, reply) {
        if( reply === undefined || !(&#39;session&#39; in reply) ) {
            console.log(&#39;error, no call session in reply&#39;)
            return
        }

        call_id = reply[&#39;session&#39;];

        client.send(&#39;CreateConf&#39;, createconf, function createConference (error, reply) {
            if( reply === undefined || !(&#39;conf_session&#39; in reply) ) {
                console.log(&#39;error, no conf_session in reply&#39;)

                termcall[&#39;session&#39;] = call_id
                client.send(&#39;HangUp&#39;, termcall, function terminateCall (error, reply) {
                    console.log(&#39;call terminated&#39;)
                });

                return
            }

            conf_id = reply[&#39;conf_session&#39;]

            addtoconf[&#39;conf_session&#39;] = conf_id;
            addtoconf[&#39;session&#39;] = call_id;

            client.send(&#39;AddToConf&#39;, addtoconf, function addToConf (error, reply) {
                if( reply === undefined ) {
                    console.log(&#39;call is not added to conf&#39;)
    
                    termcall[&#39;session&#39;] = call_id
                    client.send(&#39;HangUp&#39;, termcall, function terminateCall (error, reply) {
                        console.log(&#39;call terminated&#39;)
                    });
                }
            });
        });
    });
});

</pre>
</div></div></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="id-Примерыкода.js-Cозданиевызоваивоспроизведениесохраненногозвуковогофайла">Cоздание вызова и воспроизведение сохраненного звукового файла</h1></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">import ws from &quot;k6/ws&quot;;
import { check } from &quot;k6&quot;;

var cs = { &quot;initial&quot;:0, &quot;answered_call&quot;:1, &quot;terminated_call&quot;:2, &quot;failed&quot;:3 };

var state = 0;
var call_session = &#39;&#39;;

export default function() {
	var url = &quot;ws://10.0.0.233:8080/cc&quot;;

	var res = ws.connect(url, null, function(socket) {
        socket.on(&#39;open&#39;, function() {
    		var mkca = { &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;MakeCall&quot;, &quot;params&quot;: { &quot;anum&quot;: &quot;500&quot;, &quot;bnum&quot;: &quot;3000&quot;, &quot;record&quot;: true }, &quot;id&quot;: 1 };
		console.log(&quot;Request MakeCall sent&quot;);
            	socket.send(JSON.stringify(mkca));
		state = cs.initial;
        });

        socket.on(&#39;message&#39;, function(data) {
		var response = JSON.parse(data)
		console.log(&quot;Current state: &quot;, state);
		switch(state) {
			case cs.initial:
				call_session = response[&quot;result&quot;][&quot;data&quot;][&quot;call_session&quot;];
				console.log(&quot;Answer on MakeCall received: &quot;, call_session);

			       	var play = {&quot;jsonrpc&quot;: &quot;2.0&quot;,&quot;method&quot;: &quot;PlayAnouncement&quot;, &quot;params&quot;: {&quot;call_session&quot;: call_session,&quot;res-id&quot;: &quot;/var/opt/p90/voice_files/vcc/ringback.pcm&quot;}, &quot;id&quot;: 3};
				console.log(&quot;Request PlayAnouncement sent&quot;);

				state = cs.answered_call;
		            	socket.send(JSON.stringify(play));
				break;
			case cs.answered_call:
				if( response[&#39;error&#39;] ) {
					console.log(&quot;Answer on PlayAnouncement received: &quot;, response[&#39;error&#39;][&#39;message&#39;]);
					state = cs.failed
				} else {
					console.log(&quot;Answer on PlayAnouncement received: &quot;, response[&#39;result&#39;][&#39;message&#39;]);
					state = cs.terminated_call;
				}
				socket.close()
				break;
			default:
				console.log(&quot;Incorrect state: &quot;, state);
				socket.close()
				break;
		}
        });

        socket.on(&#39;close&#39;, function() {
		switch(state) {
			case cs.terminated_call:
				console.log(&quot;test passed - success&quot;);
				break;
			default:
				console.log(&quot;test error&quot;);
				break;
			}
            		console.log(&#39;disconnected&#39;);
        	});
	});
	check(res, { &quot;status is 101&quot;: (r) =&gt; r &amp;&amp; r.status === 101 });
}
</pre>
</div></div></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<h1 id="id-Примерыкода.js-Созданиевызоваиразрывсоединения">Создание вызова и разрыв соединения</h1></div>
</div>
</div>
<div class="columnLayout single" data-layout="single">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">import ws from &quot;k6/ws&quot;;
import { check } from &quot;k6&quot;;

var cs = { &quot;initial&quot;:0, &quot;answered_call&quot;:1, &quot;terminated_call&quot;:2, &quot;finished&quot;:3 };

var state = 0;
var call_session = &#39;&#39;;

export default function() {
	var url = &quot;ws://10.0.0.233:8080/cc&quot;;

	var res = ws.connect(url, null, function(socket) {
        socket.on(&#39;open&#39;, function() {
    		var mkca = { &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;MakeCall&quot;, &quot;params&quot;: { &quot;anum&quot;: &quot;500&quot;, &quot;bnum&quot;: &quot;3000&quot;, &quot;record&quot;: true }, &quot;id&quot;: 1 };
		console.log(&quot;Request MakeCall sent&quot;);
            	socket.send(JSON.stringify(mkca));
		state = cs.initial;
        });

        socket.on(&#39;message&#39;, function(data) {
		var response = JSON.parse(data)
		console.log(&quot;Current state: &quot;, state);
		switch(state) {
			case cs.initial:
				call_session = response[&quot;result&quot;][&quot;data&quot;][&quot;call_session&quot;];
				console.log(&quot;Answer on MakeCall received: &quot;, call_session);

			       	var term = { &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;TerminateCall&quot;, &quot;params&quot;: { &quot;call_session&quot;: call_session }, &quot;id&quot;: 2 };
				console.log(&quot;Request TerminateCall sent&quot;);

				state = cs.answered_call;
		            	socket.send(JSON.stringify(term));
				break;
			case cs.answered_call:
				console.log(&quot;Answer on TerminateCall received: &quot;, response[&quot;result&quot;][&quot;message&quot;]);

				state = cs.terminated_call;
				socket.close()
				break;
			default:
				console.log(&quot;Incorrect state: &quot;, state);
				socket.close()
				break;
		}
        });

        socket.on(&#39;close&#39;, function() {
		switch(state) {
			case cs.terminated_call:
				console.log(&quot;test passed - success&quot;);
				break;
			default:
				console.log(&quot;test error&quot;);
				break;
			}
            		console.log(&#39;disconnected&#39;);
        	});
	});
	check(res, { &quot;status is 101&quot;: (r) =&gt; r &amp;&amp; r.status === 101 });
}

</pre>
</div></div></div>
</div>
</div>
</div>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Dec 05, 2018 17:03</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
